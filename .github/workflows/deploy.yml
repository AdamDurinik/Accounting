name: Auto-Deploy PriceTags (Velopack)

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 

      # 1. Build - RID must be win-x64
      - name: Build and Publish
        run: dotnet publish PriceTags\PriceTags.csproj -c Release -r win-x64 --self-contained -o ./out

      # 2. Setup Velopack Tool
      - name: Setup Velopack
        shell: powershell
        run: |
          try { dotnet tool install -g vpk } catch { dotnet tool update -g vpk }

      # 3. Create the update package (Using the EXACT flags from your error log)
      - name: Pack with Velopack
        shell: powershell
        run: |
          $vpkPath = "$env:USERPROFILE\.dotnet\tools\vpk.exe"
          $vpkArgs = @(
            "pack",
            "--packId", "PriceTags",
            "--packVersion", "1.1.${{ github.run_number }}",
            "--packDir", "./out",
            "--mainExe", "PriceTags.exe",
            "--packAuthors", "FoxHint, Adam Ďuriník",
            "--icon", "F:\actions-runner\_work\Accounting\Resources\PriceTags.ico",
            "--splash", "F:\actions-runner\_work\Accounting\Resources\loading.gif",
            "-o", "./releases",
            "-r", "win-x64"
          )
          & $vpkPath @vpkArgs
      # --signParams "/f F:\Cert\FoxHintSign.pfx /p '${{ secrets.CERT_PASSWORD }}' /fd sha256"

      # 4. Deploy to IIS
      - name: Deploy to IIS
        shell: powershell
        run: |
          $source = "./releases/*"
          $destination = "C:\inetpub\wwwroot\pricetags\updates"
          if (Test-Path $destination) { Remove-Item "$destination\*" -Recurse -Force }
          else { New-Item -ItemType Directory -Path $destination -Force }
          Copy-Item -Path $source -Destination $destination -Recurse -Force
