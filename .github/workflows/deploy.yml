name: Auto-Deploy PriceTags (Velopack)

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 

      # 1. Standard build - no more ClickOnce mess
      - name: Build and Publish
        run: dotnet publish PriceTags\PriceTags.csproj -c Release -o ./out

      # 2. Install/Update Velopack tool
      - name: Setup Velopack
        shell: powershell
        run: |
          try {
            dotnet tool install -g vpk
          } catch {
            dotnet tool update -g vpk
          }

      # 3. Create the update package
      - name: Pack with Velopack
        run: |
          vpk pack -u PriceTags `
          -v 1.1.${{ github.run_number }} `
          -p ./out `
          -e PriceTags.exe `
          -o ./releases

      # 4. Deploy to IIS
      - name: Deploy to IIS
        shell: powershell
        run: |
          $source = "./releases/*"
          $destination = "C:\inetpub\wwwroot\pricetags\updates"

          if (Test-Path $destination) { Remove-Item "$destination\*" -Recurse -Force }
          else { New-Item -ItemType Directory -Path $destination -Force }

          # Just copy everything in 'releases' - it's clean (no junk DLLs)
          Copy-Item -Path $source -Destination $destination -Recurse -Force
