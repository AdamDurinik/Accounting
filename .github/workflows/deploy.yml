name: Auto-Deploy PriceTags

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build & Publish ClickOnce
        run: |
          # 1. We send the ACTUAL ClickOnce installer files to a specific unique folder
          # 2. We send the 200 junk files (OutDir) to a temporary folder we will ignore
          # IMPORTANT: Use double backslashes for paths in MSBuild arguments
          msbuild PriceTags\PriceTags.csproj -t:publish -restore `
          -p:Configuration=Release `
          -p:PublishProfile="Properties\PublishProfiles\ClickOnceProfile.pubxml" `
          -p:PublishDir="bin\CLICKONCE_OUTPUT\\" `
          -p:OutDir="obj\BUILD_JUNK\\"

      - name: Deploy to IIS
        shell: powershell
        run: |
          # MSBuild often creates 'app.publish' inside the PublishDir. 
          # We look for the folder that contains 'setup.exe'
          $basePath = "${{ github.workspace }}\PriceTags\bin\CLICKONCE_OUTPUT"
          
          # Check if MSBuild put it in a subfolder called app.publish (common .NET 9 behavior)
          if (Test-Path "$basePath\app.publish") { $source = "$basePath\app.publish\*" }
          else { $source = "$basePath\*" }
          
          $destination = "C:\inetpub\wwwroot\pricetags\updates"
          
          Write-Host "Deploying from $source to $destination"

          # 1. Nuke the destination to ensure zero leftover DLLs
          if (Test-Path $destination) { Remove-Item "$destination\*" -Recurse -Force }
          else { New-Item -ItemType Directory -Path $destination -Force }
          
          # 2. Copy only the installer files
          Copy-Item -Path $source -Destination $destination -Recurse -Force
          
          # 3. Rename setup.exe so the users have a nice filename
          if (Test-Path "$destination\setup.exe") {
            Move-Item -Path "$destination\setup.exe" -Destination "$destination\PriceTags.exe" -Force
          }
