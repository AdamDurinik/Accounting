name: Auto-Deploy PriceTags

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore Packages
        # This creates the project.assets.json files you were missing
        run: msbuild PriceTags\PriceTags.csproj /t:restore /p:Configuration=Release

      - name: Build & Publish ClickOnce
        run: |
          # Use -restore to fix the 'assets file not found' error in one go
          # Use the FULL path to the .csproj
          # Use the FULL path to the .pubxml
          msbuild PriceTags\PriceTags.csproj -restore `
          /target:publish `
          /p:Configuration=Release `
          /p:PublishProfile="${{ github.workspace }}\PriceTags\Properties\PublishProfiles\ClickOnceProfile.pubxml" `
          /p:PublishDir="bin\app_publish\" `
          /p:PublishUrl="bin\app_publish\"
      - name: Deploy to IIS
        shell: powershell
        run: |
          # Path adjusted to the PriceTags project folder
          $source = "PriceTags\bin\app_publish\."
          $destination = "C:\inetpub\wwwroot\pricetags\updates\"
          
          # Create folder if missing
          if (!(Test-Path $destination)) { 
            New-Item -ItemType Directory -Path $destination -Force 
          }
          
          # Copy files from the project build folder to the IIS folder
          xcopy $source $destination /E /Y /I
          
          # Rename Setup.exe to PriceTags.exe
          if (Test-Path "$destination\setup.exe") {
            Move-Item -Path "$destination\setup.exe" -Destination "$destination\PriceTags.exe" -Force
          }
