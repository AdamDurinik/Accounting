name: Auto-Deploy PriceTags (Velopack)

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 

      # 1. Build - Must include Runtime Identifier (-r) for Velopack
      - name: Build and Publish
        run: dotnet publish PriceTags\PriceTags.csproj -c Release -r win-x64 --self-contained -o ./out

      # 2. Setup Velopack Tool (Fixed PowerShell Syntax)
      - name: Setup Velopack
        shell: powershell
        run: |
          try {
            dotnet tool install -g vpk
          } catch {
            dotnet tool update -g vpk
          }

      # 3. Create the update package (Fixed PATH and Command)
      - name: Pack with Velopack
        shell: powershell
        run: |
          # Ensure the runner sees the new tool path
          $env:PATH += ";$env:USERPROFILE\.dotnet\tools"
          
          dotnet vpk pack -u PriceTags `
          -v 1.1.${{ github.run_number }} `
          -p ./out `
          -e PriceTags.exe `
          -o ./releases

      # 4. Deploy to IIS
      - name: Deploy to IIS
        shell: powershell
        run: |
          $source = "./releases/*"
          $destination = "C:\inetpub\wwwroot\pricetags\updates"

          # Wipe destination if exists
          if (Test-Path $destination) { 
              Remove-Item "$destination\*" -Recurse -Force 
          } else { 
              New-Item -ItemType Directory -Path $destination -Force 
          }

          # Copy clean releases
          Copy-Item -Path $source -Destination $destination -Recurse -Force
