name: Auto-Deploy PriceTags (Velopack)

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4 

      # 1. Build - RID must be provided for Velopack to pack correctly
      - name: Build and Publish
        run: dotnet publish PriceTags\PriceTags.csproj -c Release -r win-x64 --self-contained -o ./out

      # 2. Setup Velopack Tool (PowerShell compatible try/catch)
      - name: Setup Velopack
        shell: powershell
        run: |
          try { dotnet tool install -g vpk } catch { dotnet tool update -g vpk }

      # 3. Create the update package (Explicit Path & Correct Flag)
      - name: Pack with Velopack
        shell: powershell
        run: |
          $vpkPath = "$env:USERPROFILE\.dotnet\tools\vpk.exe"
          & $vpkPath pack --id "PriceTags" `
            --version "1.1.${{ github.run_number }}" `
            --packDir "./out" `
            --mainExe "PriceTags.exe" `
            --outputDir "./releases" `
            --packarch "win-x64"

      # 4. Deploy to IIS
      - name: Deploy to IIS
        shell: powershell
        run: |
          $source = "./releases/*"
          $destination = "C:\inetpub\wwwroot\pricetags\updates"

          if (Test-Path $destination) { 
              Remove-Item "$destination\*" -Recurse -Force 
          } else { 
              New-Item -ItemType Directory -Path $destination -Force 
          }

          Copy-Item -Path $source -Destination $destination -Recurse -Force
