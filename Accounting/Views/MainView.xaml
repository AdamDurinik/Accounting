<UserControl x:Class="Accounting.Views.MainView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Accounting.Views" 
             xmlns:dxg="http://schemas.devexpress.com/winfx/2008/xaml/grid" 
             xmlns:dxb="http://schemas.devexpress.com/winfx/2008/xaml/bars" 
             xmlns:viewmodels="clr-namespace:Accounting.ViewModels"
             xmlns:dxmvvm="clr-namespace:DevExpress.Mvvm.UI.Interactivity;assembly=DevExpress.Xpf.Core.v24.1" 
             xmlns:dx="clr-namespace:DevExpress.Xpf.Core;assembly=DevExpress.Xpf.Core.v24.1"
             xmlns:dxe="http://schemas.devexpress.com/winfx/2008/xaml/editors" xmlns:dmvvm="http://schemas.devexpress.com/winfx/2008/xaml/mvvm"
             mc:Ignorable="d"
             d:DataContext="{d:DesignInstance viewmodels:MainViewModel}">
    <dxmvvm:Interaction.Behaviors>
        <dx:DialogService x:Name="SelectFileService" DialogWindowStartupLocation="CenterOwner">
            <dx:DialogService.ViewTemplate>
                <DataTemplate>
                    <local:SelectFileView />
                </DataTemplate>
            </dx:DialogService.ViewTemplate>
            <dx:DialogService.DialogStyle>
                <Style TargetType="Window">
                    <Setter Property="Height" Value="600" />
                    <Setter Property="Width" Value="400" />
                    <Setter Property="ResizeMode" Value="NoResize" />
                </Style>
            </dx:DialogService.DialogStyle>
        </dx:DialogService>
        <dx:DialogService x:Name="SaveFileService" DialogWindowStartupLocation="CenterOwner">
            <dx:DialogService.ViewTemplate>
                <DataTemplate>
                    <local:SaveDialogView />
                </DataTemplate>
            </dx:DialogService.ViewTemplate>
            <dx:DialogService.DialogStyle>
                <Style TargetType="Window">
                    <Setter Property="ResizeMode" Value="NoResize" />
                    <Setter Property="SizeToContent" Value="WidthAndHeight" />
                </Style>
            </dx:DialogService.DialogStyle>
        </dx:DialogService>
        <dx:DXMessageBoxService />
        <dmvvm:SaveFileDialogService x:Name="SaveFileDialogService"
         DefaultExt="xlsx"
         Filter="Excel files (*.xlsx)|*.xlsx|All files (*.*)|*.*"
         OverwritePrompt="True" />
    </dxmvvm:Interaction.Behaviors>
    <Grid Margin="5,0,5,5">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0">
            <!-- Main toolbar card -->
            <Border BorderBrush="LightGray"
               BorderThickness="1"
               CornerRadius="4"
               Padding="6"
               Margin="10,0,10,4"
               Background="White">
                <StackPanel>
                    <dxb:BarManager>
                        <dxb:BarManager.Bars>

                            <dxb:Bar IsMainMenu="True" BarItemDisplayMode="ContentAndGlyph">
                                <dxb:BarButtonItem Content="Nový" Glyph="/Icons/addFile.png"
                                      Padding="5" Margin="5"
                                      Command="{Binding CreateNewFileCommand}" />
                                <dxb:BarButtonItem Content="Otvoriť súbor" Glyph="/Icons/open.png"
                                      Padding="5" Margin="5"
                                      Command="{Binding OpenFileCommand}" />
                                <dxb:BarButtonItem Content="Uložiť" Glyph="/Icons/save.png"
                                      Padding="5" Margin="5"
                                      Command="{Binding SaveFileCommand}" />
                                <dxb:BarButtonItem Content="Uložiť ako" Glyph="/Icons/save.png"
                                      Padding="5" Margin="5"
                                      Command="{Binding SaveAsFileCommand}" />
                                <dxb:BarButtonItem Content="Exportovať do Excelu" Glyph="/Icons/excel.png"
                                      Padding="5" Margin="5"
                                      Command="{Binding ExportToExcelCommand}" />
                            </dxb:Bar>
                        </dxb:BarManager.Bars>
                    </dxb:BarManager>

                    <!-- Secondary toolbar card -->
                    <Border BorderBrush="LightGray"
                       BorderThickness="1"
                       CornerRadius="4"
                       Padding="0"
                       Margin="0,0,0,0"
                       Background="White">  

                    </Border>

                    <dxb:BarManager>
                        <dxb:BarManager.Bars>
                            <dxb:Bar IsMainMenu="True" BarItemDisplayMode="ContentAndGlyph">
                                <dxb:BarButtonItem Content="Pridať tabulku" Glyph="/Icons/plus.png"
                           Padding="5" Margin="5"
                                      Command="{Binding AddTableCommand}" />
                            </dxb:Bar>
                        </dxb:BarManager.Bars>
                    </dxb:BarManager>
                </StackPanel>
            </Border>

        </StackPanel>

        <ScrollViewer Margin="10" Grid.Row="1"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Disabled">
            <ItemsControl ItemsSource="{Binding Columns}"
                          VerticalAlignment="Stretch">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border BorderBrush="LightGray" 
                                BorderThickness="1"
                                CornerRadius="6"
                                Padding="8"
                                Margin="0,0,16,0"
                                Background="White"
                                VerticalAlignment="Stretch"
                                RenderTransformOrigin="0.5,0.5">
                            <!-- Pop-out animation -->
                            <Border.RenderTransform>
                                <ScaleTransform ScaleX="1" ScaleY="1" />
                            </Border.RenderTransform>
                            <Border.Triggers>
                                <EventTrigger RoutedEvent="Loaded">
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="RenderTransform.(ScaleTransform.ScaleX)"
                                                             From="0" To="1" Duration="0:0:0.2" />
                                            <DoubleAnimation Storyboard.TargetProperty="RenderTransform.(ScaleTransform.ScaleY)"
                                                             From="0" To="1" Duration="0:0:0.2" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </EventTrigger>
                                <EventTrigger RoutedEvent="Unloaded">
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetProperty="RenderTransform.(ScaleTransform.ScaleX)"
                                                             From="1" To="0" Duration="0:0:0.2" />
                                            <DoubleAnimation Storyboard.TargetProperty="RenderTransform.(ScaleTransform.ScaleY)"
                                                             From="1" To="0" Duration="0:0:0.2" />
                                        </Storyboard>
                                    </BeginStoryboard>
                                </EventTrigger>
                            </Border.Triggers>

                            <!-- Layout grid: auto height for tax row, star height for grid -->
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>

                                <!-- Tax input -->
                                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,8">
                                    <TextBlock Text="DPH:" VerticalAlignment="Center" Margin="0,0,5,0" />
                                    <dxe:TextEdit Width="45" CornerRadius="6"
                                                  Text="{Binding Tax, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                  MaskType="Numeric" Mask="D">
                                    </dxe:TextEdit>
                                    <TextBlock Text="%" VerticalAlignment="Center" Margin="5,0,5,0" />

                                    <Button Command="{Binding DataContext.DeleteColumnCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}" HorizontalAlignment="Right" Margin="147,0,0,0"                                                                                 
                                            BorderThickness="0" BorderBrush="Transparent" Padding="3">
                                        <Image Source="/Icons/remove.png" Width="16" Height="16" />
                                    </Button>
                                </StackPanel>

                                <dxg:GridControl Grid.Row="1" Width="250" ItemsSource="{Binding Items}" BorderThickness="0" PreviewKeyDown="OnPreviewKeyDown">
                                    <dxg:GridControl.TotalSummary>
                                        <dxg:GridSummaryItem FieldName="PriceWithoutTax" SummaryType="Sum" DisplayFormat=" {0:N3} €" ShowInColumn="PriceWithoutTax" />
                                        <dxg:GridSummaryItem FieldName="Tax" SummaryType="Sum" DisplayFormat=" {0:N2} €" ShowInColumn="Tax" />
                                        <dxg:GridSummaryItem FieldName="PriceWithTax" SummaryType="Sum" DisplayFormat=" {0:N2} €" ShowInColumn="PriceWithTax" />
                                    </dxg:GridControl.TotalSummary>
                                    <dxg:GridControl.View>
                                        <dxg:TableView AutoWidth="True" ShowGroupPanel="False" ShowFilterPanelMode="Never" AllowColumnFiltering="False" AllowSorting="False"
                                           AllowGrouping="False" AllowColumnMoving="False" TotalSummaryPosition="Bottom" NewItemRowPosition="Bottom"
                                           EnableImmediatePosting="True" AddingNewRow="OnAddingNewRow" BorderThickness="0">

                                        </dxg:TableView>
                                    </dxg:GridControl.View>
                                    <dxg:GridColumn FieldName="PriceWithoutTax" Header="Cena" />
                                    <dxg:GridColumn FieldName="Tax" Header="DPH" />
                                    <dxg:GridColumn FieldName="PriceWithTax" Header="Celkovo" />
                                    <dxg:GridColumn Width="30">
                                        <dxg:GridColumn.CellTemplate>
                                            <DataTemplate>
                                                <dx:SimpleButton Command="{Binding DataContext.DeleteRowCommand,RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                     CommandParameter="{Binding RowData.Row}" BorderThickness="0"
                                                     BorderBrush="Transparent" Glyph="/Icons/remove2.png" Padding="3" />    
                                            </DataTemplate>
                                        </dxg:GridColumn.CellTemplate>
                                    </dxg:GridColumn>
                                </dxg:GridControl>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>

</UserControl>
